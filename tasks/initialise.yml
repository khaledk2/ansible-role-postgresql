---
# tasks file for ome.postgresql
##Ansible managed

- block:
    - name: postgres | set permissions on data directory
      file:
        owner: postgres
        group: postgres
        path: "{{ postgresql_dist_datadir }}"
        state: directory
        mode: 0700
      when: postgresql_server_chown_datadir

    - name: >-
        postgres | initialise PostgreSQL cluster (skip if data directory
        already exists)
      command: "{{ postgresql_dist_setup }}"
      args:
        creates: "{{ postgresql_dist_datadir }}/PG_VERSION"

      environment:
        PGSETUP_INITDB_OPTIONS: >-
          --encoding=UTF8 --locale=en_US.UTF-8 --auth-host=md5

    - name: postgres | Check for presence of "Modified by ome postgresql ansible role" in file
      ansible.builtin.lineinfile:
        path: "{{ postgresql_dist_confdir }}/postgresql.conf"
        line: "#Ansible managed"
        state: absent
      check_mode: yes
      changed_when: false
      register: config_file_changed

    - name: postgres | Check that the postgresql.conf.backup file exists
      ansible.builtin.stat:
        path: "{{ postgresql_dist_confdir }}/postgresql.conf.org"
      register: org_file

    # read the default postgresql configuration file
    - name: postgres | get the postgres conf file contents
      become_user: "{{ postgresql_become_user }}"
      ansible.builtin.slurp:
        src: "{{ postgresql_dist_confdir }}/postgresql.conf"
      register: postgres_config_file_contents_o
      when:
        - not org_file.stat.exists

    - name: Print the org_file.stat.exists
      ansible.builtin.debug:
       msg:
       - System 1 {{ org_file.stat.exists }} and {{ config_file_changed.found }}
       - "{{ postgresql_dist_confdir }}/postgresql.conf.org"
       - "{{ postgresql_dist_redhat.conf_sample_file }}"

    - name: postgres | get the orginal configuration file
      become_user: "{{ postgresql_become_user }}"
      import_tasks: org_config_file.yml
      when:
        - not org_file.stat.exists
        - config_file_changed.found

    - name: postgres | get the orginal configuration file
      become_user: "{{ postgresql_become_user }}"
      ansible.builtin.slurp:
        src: "{{ postgresql_dist_confdir }}/postgresql.conf.org"
      register: postgres_config_file_contents_c
      when:
        - not org_file.stat.exists
        - config_file_changed.found


    # read the default postgresql configuration file
    - name: postgres | get the postgres conf file contents from org
      become_user: "{{ postgresql_become_user }}"
      ansible.builtin.slurp:
        src: "{{ postgresql_dist_confdir }}/postgresql.conf.org"
      register: postgres_config_file_contents_b
      when: org_file.stat.exists


    - set_fact: postgres_config_file_contents={{ postgres_config_file_contents_o }}
      when:
        - not org_file.stat.exists

    - set_fact: postgres_config_file_contents={{ postgres_config_file_contents_b }}
      when:
        - org_file.stat.exists

    - set_fact: postgres_config_file_contents={{ postgres_config_file_contents_c }}
      when:
        - not org_file.stat.exists
        - config_file_changed.found

    - name: postgres | Copy a postgresql.conf to postgresql.conf.org
      become_user: "{{ postgresql_become_user }}"
      ansible.builtin.copy:
        src: "{{ postgresql_dist_confdir }}/postgresql.conf"
        dest: "{{ postgresql_dist_confdir }}/postgresql.conf.org"
        remote_src: yes
      when:
        - not org_file.stat.exists
        - config_file_changed.found | default(0) == 0

    - name: Print the org_file.stat.exists
      ansible.builtin.debug:
        msg: System {{ org_file.stat.exists }} and {{ config_file_changed.found }}
      # when:
      #  -  (not org_file.stat.exists and config_file_changed.found) or  config_file_changed.found or org_file.stat.exists

    - name: postgres | copy postgresql config file
      become_user: "{{ postgresql_become_user }}"
      ansible.builtin.template:
        dest: >-
          {{ postgresql_dist_confdir }}/postgresql.conf
        src: "{{ postgresql_dist_conf_postgresql_src }}"
        mode: 0644
        owner: "{{ postgresql_become_user }}"
      notify:
        - restart postgresql
      when: (not org_file.stat.exists and config_file_changed.found) or  not config_file_changed.found or org_file.stat.exists
        # -  not org_file.stat.exists
        # - config_file_changed.found

    - name: postgres | configure client authorisation
      become_user: "{{ postgresql_become_user }}"
      template:
        dest: "{{ postgresql_dist_confdir }}/pg_hba.conf"
        src: pg_hba-conf.j2
        mode: 0640
      notify:
        - restart postgresql

    - name: postgres | start service
      service:
        enabled: true
        name: "{{ postgresql_dist_service }}"
        state: started

  become: true
