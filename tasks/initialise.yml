---
# tasks file for ome.postgresql

- block:
    - name: postgres | set permissions on data directory
      file:
        owner: postgres
        group: postgres
        path: "{{ postgresql_dist_datadir }}"
        state: directory
        mode: 0700
      when: postgresql_server_chown_datadir

    - name: >-
        postgres | initialise PostgreSQL cluster (skip if data directory
        already exists)
      command: "{{ postgresql_dist_setup }}"
      args:
        creates: "{{ postgresql_dist_datadir }}/PG_VERSION"

      environment:
        PGSETUP_INITDB_OPTIONS: >-
          --encoding=UTF8 --locale=en_US.UTF-8 --auth-host=md5

    - name: postgres | Check for presence of "Modified by ome postgresql ansible role" in file
      ansible.builtin.lineinfile:
        path: "{{ postgresql_dist_confdir }}/postgresql.conf"
        line: "#Modified by ome postgresql ansible role"
        state: absent
      check_mode: yes
      changed_when: false
      register: config_file_changed

    # read the default postgresql configuration file
    - name: postgres | get the postgres conf file contents
      become_user: "{{ postgresql_become_user }}"
      ansible.builtin.slurp:
        src: "{{ postgresql_dist_confdir }}/postgresql.conf"
      register: postgres_config_file_contents
      when: config_file_changed.found | default(0) == 0


    - name: postgres | postgresql config file
      ansible.builtin.template:
        dest: >-
          {{ postgresql_dist_confdir }}/postgresql.conf
        src: "{{ postgresql_dist_conf_postgresql_src }}"
        mode: 0644
        owner: "{{ postgresql_become_user }}"
      notify:
        - restart postgresql
      when: config_file_changed.found | default(0) == 0


    - name: postgres | configure client authorisation
      template:
        dest: "{{ postgresql_dist_confdir }}/pg_hba.conf"
        src: pg_hba-conf.j2
        mode: 0640
      notify:
        - restart postgresql

      become_user: "{{ postgresql_become_user }}"

    - name: postgres | start service
      service:
        enabled: true
        name: "{{ postgresql_dist_service }}"
        state: started

  become: true
